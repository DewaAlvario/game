<?php
include "dbconn/dbconn.php";

if ($conn->connect_error) {
    die("Koneksi gagal: " . $conn->connect_error);
}

// Buat database jika belum ada
$namadb = "detective_academia";
$makedb = "CREATE DATABASE IF NOT EXISTS $namadb";
$conn->query($makedb);
$conn->select_db($namadb);

// Buat tabel jika belum ada
$buatTabel = "CREATE TABLE IF NOT EXISTS results (
    ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    nmrID VARCHAR(50) NOT NULL,
    score INT NOT NULL
)";
$conn->query($buatTabel);

// Proses penyimpanan skor
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    if (!isset($_POST['participantId']) || !isset($_POST['score'])) {
        echo json_encode(["status" => "error", "message" => "Data tidak lengkap"]);
        exit();
    }

    $nmrID = trim($_POST['participantId']);
    $score = intval($_POST['score']);

    if (empty($nmrID) || strlen($nmrID) < 4) {
        echo json_encode(["status" => "error", "message" => "ID peserta tidak valid"]);
        exit();
    }

    $stmt = $conn->prepare("INSERT INTO results (nmrID, score) VALUES (?, ?)");
    if ($stmt === false) {
        echo json_encode(["status" => "error", "message" => "Error dalam prepare statement"]);
        exit();
    }

    $stmt->bind_param("si", $nmrID, $score);
    
    if ($stmt->execute()) {
        echo json_encode(["status" => "success", "message" => "Data berhasil disimpan!"]);
    } else {
        echo json_encode(["status" => "error", "message" => "Gagal menyimpan data: " . $stmt->error]);
    }

    $stmt->close();
}
?>
